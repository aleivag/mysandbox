---
# vi: ts=2 sw=2 et:
# SPDX-License-Identifier: LGPL-2.1-or-later
# Simple boot tests that build and boot the mkosi images generated by the mkosi config files in mkosi.conf.d/.
name: mkosi

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  main:
    runs-on: ubuntu-22.04

    steps:
    - uses: actions/checkout@v3

    - name: install podman
      run: sudo apt-get install podman debootstrap systemd-container

    - name: runing ps
      run: sudo ps auxf

    - name: tetsing systemd
      run: sudo systemctl status

    - name: testing nspawn
      run: systemd-nspawn --help

    - name: build debian
      run: mkdir /opt/debian && sudo debootstrap --include 'dbus,vim' unstable /opt/debian

    - name: runing nspawn
      timeout-minutes: 1
      run: sudo systemd-run --unit tect.service systemd-nspawn --boot -D /opt/debian --machine testc

    - name: wait for container boot
      timeout-minutes: 1
      run: |
        while ! sudo systemd-run --tty --machine testc /bin/true 
        do  
            sudo systemctl status tect.service
        done

    - name: exec command
      run: sudo systemd-run --tty --machine testc python3 /opt/rel.py